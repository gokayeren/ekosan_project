{% extends "base.html" %}

{# --- SEO META TAGLARI --- #}
{% block title %}{{ product.meta_title or product.name }} | Ekosan{% endblock %}

{% block head %}
    <meta name="description" content="{{ product.meta_description or product.short_description }}">
    <meta name="keywords" content="{{ product.meta_keywords }}">
    
    {# SCHEMA.ORG YAPISAL VERİ (Google İçin Çok Önemli) #}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "Product",
      "name": "{{ product.name }}",
      "image": [
        "{{ url_for('static', filename='uploads/' + product.image_file, _external=True) }}"
        {% for img in product.images %}
        ,"{{ url_for('static', filename='uploads/' + img.image_path, _external=True) }}"
        {% endfor %}
      ],
      "description": "{{ product.short_description or product.meta_description }}",
      "brand": {
        "@type": "Brand",
        "name": "Ekosan"
      },
      "offers": {
        "@type": "Offer",
        "url": "{{ request.url }}",
        "priceCurrency": "TRY",
        "price": "{{ product.price or '0' }}",
        "availability": "https://schema.org/InStock",
        "itemCondition": "https://schema.org/NewCondition"
      }
    }
    </script>
{% endblock %}

{% block content %}

{# --- BREADCRUMB (Navigasyon Yolu) --- #}
<div class="bg-gray-50 border-b border-gray-200 py-3">
    <div class="container mx-auto px-4 max-w-7xl">
        <div class="text-xs md:text-sm breadcrumbs text-gray-500">
            <ul>
                <li><a href="/">Anasayfa</a></li>
                <li><a href="#">Ürün & Hizmetler</a></li>
                {% if main_service %}
                <li><a href="#" class="hover:text-ekosan-blue">{{ main_service.title }}</a></li>
                {% endif %}
                <li class="font-bold text-gray-800">{{ product.name }}</li>
            </ul>
        </div>
    </div>
</div>

{# --- ÜRÜN ÜST BÖLÜM (Görsel + Özet) --- #}
<section class="py-10 md:py-16 bg-white">
    <div class="container mx-auto px-4 max-w-7xl">
        <div class="flex flex-col lg:flex-row gap-10 lg:gap-16">
            
            {# SOL: RESİM GALERİSİ #}
            <div class="w-full lg:w-1/2">
                <div class="relative bg-gray-50 rounded-2xl overflow-hidden border border-gray-100 mb-4 group h-[350px] md:h-[500px] flex items-center justify-center">
                    {# Ana Resim #}
                    <img id="mainImage" 
                         src="{{ url_for('static', filename='uploads/' + product.image_file) }}" 
                         alt="{{ product.name }}" 
                         class="w-full h-full object-contain p-4 transition-transform duration-500 group-hover:scale-105"
                         loading="eager">
                    
                    <div class="absolute top-4 left-4 z-10">
                        {% if product.services %}
                        <span class="badge bg-ekosan-blue text-white border-none py-3 px-4 font-bold shadow-lg shadow-blue-200">
                            {{ product.services[0].title }}
                        </span>
                        {% endif %}
                    </div>
                </div>

                {# Küçük Resimler (Varsa) #}
                {% if product.images %}
                <div class="grid grid-cols-5 gap-2 md:gap-4">
                    {# Ana resmin kendisi de thumb olarak ekleniyor #}
                    <div onclick="changeImage('{{ url_for('static', filename='uploads/' + product.image_file) }}')" 
                         class="cursor-pointer border-2 border-transparent hover:border-ekosan-blue rounded-xl bg-gray-50 h-20 md:h-24 flex items-center justify-center p-1 transition-all overflow-hidden">
                        <img src="{{ url_for('static', filename='uploads/' + product.image_file) }}" class="w-full h-full object-contain">
                    </div>

                    {% for img in product.images %}
                    <div onclick="changeImage('{{ url_for('static', filename='uploads/' + img.image_path) }}')" 
                         class="cursor-pointer border-2 border-transparent hover:border-ekosan-blue rounded-xl bg-gray-50 h-20 md:h-24 flex items-center justify-center p-1 transition-all overflow-hidden relative group">
                        <img src="{{ url_for('static', filename='uploads/' + img.image_path) }}" 
                             class="w-full h-full object-contain" 
                             alt="{{ img.title }}">
                        {% if img.title %}
                        <div class="absolute bottom-0 left-0 w-full bg-black/60 text-white text-[9px] text-center py-0.5 truncate px-1">
                            {{ img.title }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            {# SAĞ: BİLGİ VE AKSİYON #}
            <div class="w-full lg:w-1/2 flex flex-col">
                <h1 class="text-3xl md:text-4xl lg:text-5xl font-black text-gray-900 mb-4 leading-tight">
                    {{ product.name }}
                </h1>

                {# Varsa Hizmet Etiketleri #}
                {% if product.services %}
                <div class="flex flex-wrap gap-2 mb-6">
                    {% for srv in product.services %}
                    <span class="text-xs font-bold uppercase tracking-wider text-gray-500 bg-gray-100 px-2 py-1 rounded">
                        <i class="fa fa-tag mr-1 text-orange-500"></i> {{ srv.title }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
                
                {# Kısa Açıklama #}
                {% if product.short_description %}
                <p class="text-gray-600 text-lg leading-relaxed mb-8 border-l-4 border-orange-500 pl-4 bg-orange-50/50 py-2 rounded-r-lg">
                    {{ product.short_description }}
                </p>
                {% endif %}

                {# Fiyat Bilgisi (Sadece girildiyse göster) #}
                {% if product.price %}
                <div class="mb-8">
                    <span class="block text-sm text-gray-400 font-medium mb-1">Tahmini Başlangıç Fiyatı</span>
                    <div class="flex items-baseline gap-2">
                        <span class="text-3xl font-bold text-ekosan-blue">{{ "{:,.2f}".format(product.price) }} ₺</span>
                        <span class="text-xs text-gray-400 font-light">+ KDV</span>
                    </div>
                </div>
                {% endif %}

                {# Aksiyon Butonları #}
                <div class="mt-auto flex flex-col sm:flex-row gap-4">
                    <a href="/teklif-al" class="btn btn-lg bg-ekosan-dark text-white hover:bg-gray-800 border-none flex-1 gap-3 shadow-xl shadow-gray-200">
                        <i class="fa fa-file-signature"></i>
                        Hemen Teklif Al
                    </a>
                    {% if site_settings.phone_number %}
                    <a href="https://wa.me/{{ site_settings.phone_number|replace(' ','') }}" target="_blank" class="btn btn-lg btn-outline border-2 border-green-500 text-green-600 hover:bg-green-500 hover:border-green-500 hover:text-white flex-1 gap-3">
                        <i class="fab fa-whatsapp text-xl"></i>
                        WhatsApp Bilgi
                    </a>
                    {% endif %}
                </div>
                
                <div class="mt-6 flex items-center gap-4 text-xs text-gray-400 bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <div class="flex items-center gap-2">
                        <i class="fa fa-check-circle text-green-500"></i> Ücretsiz Keşif
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fa fa-check-circle text-green-500"></i> Profesyonel Montaj
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fa fa-check-circle text-green-500"></i> 2 Yıl Garanti
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

{# --- DETAYLI İÇERİK SEKMELERİ (TABS) --- #}
<section class="py-16 bg-gray-50 border-t border-gray-200 relative overflow-hidden">
    
    <div class="container mx-auto px-4 max-w-5xl relative z-10">
        
        {# Tab Başlıkları #}
        <div role="tablist" class="tabs tabs-bordered tabs-lg mb-8 grid-cols-2">
            <input type="radio" name="product_tabs" role="tab" class="tab font-bold text-lg" aria-label="Ürün Açıklaması" checked />
            <div role="tabpanel" class="tab-content bg-white border-base-300 rounded-box p-8 md:p-12 shadow-sm min-h-[300px]">
                
                {# Gelişmiş İçerik Alanı (WYSIWYG Editörden Gelen) #}
                <div class="prose prose-lg max-w-none prose-headings:text-ekosan-dark prose-a:text-orange-600 prose-img:rounded-xl">
                    {{ product.description|safe }}
                </div>

            </div>

            {% if product.tech_specs %}
            <input type="radio" name="product_tabs" role="tab" class="tab font-bold text-lg" aria-label="Teknik Özellikler" />
            <div role="tabpanel" class="tab-content bg-white border-base-300 rounded-box p-8 md:p-12 shadow-sm min-h-[300px]">
                
                <div class="overflow-x-auto">
                    <div class="prose prose-slate max-w-none">
                        {{ product.tech_specs|safe }}
                    </div>
                </div>

            </div>
            {% endif %}
        </div>

    </div>
</section>

{# --- BENZER HİZMETLER / CTA BAR --- #}
{% if main_service and main_service.products|length > 1 %}
<section class="py-16 bg-white">
    <div class="container mx-auto px-4 max-w-7xl">
        <h3 class="text-2xl font-bold text-gray-900 mb-8 border-l-4 border-ekosan-blue pl-4">
            Diğer {{ main_service.title }} Seçenekleri
        </h3>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {% for other_prod in main_service.products[:4] %}
                {% if other_prod.id != product.id %}
                <a href="{{ url_for('main.product_detail', slug=other_prod.slug) }}" class="card bg-base-100 shadow-sm border border-gray-100 hover:shadow-xl transition-all duration-300 group">
                    <figure class="px-4 pt-4 bg-gray-50 h-48 flex items-center justify-center">
                        <img src="{{ url_for('static', filename='uploads/' + other_prod.image_file) }}" alt="{{ other_prod.name }}" class="object-contain h-full w-full p-2 group-hover:scale-105 transition-transform" />
                    </figure>
                    <div class="card-body p-5">
                        <h2 class="card-title text-base font-bold text-gray-800 line-clamp-2">
                            {{ other_prod.name }}
                        </h2>
                        <div class="card-actions justify-end mt-2">
                            <span class="text-xs font-bold text-orange-500 group-hover:translate-x-1 transition-transform">İncele <i class="fa fa-arrow-right"></i></span>
                        </div>
                    </div>
                </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

{# --- MOBİL İÇİN YAPIŞKAN BAR (STICKY BOTTOM) --- #}
<div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-3 shadow-[0_-5px_20px_rgba(0,0,0,0.1)] z-40 lg:hidden flex gap-3">
    <a href="tel:{{ site_settings.phone_number }}" class="btn flex-1 bg-ekosan-dark text-white border-none">
        <i class="fa fa-phone"></i> Ara
    </a>
    <a href="/teklif-al" class="btn flex-1 btn-warning text-white bg-orange-500 border-none">
        Teklif Al
    </a>
</div>
<div class="h-16 lg:hidden"></div> {# Sticky barın içeriği kapatmaması için boşluk #}

<script>
    function changeImage(src) {
        const mainImg = document.getElementById('mainImage');
        // Basit bir fade-out efekti
        mainImg.style.opacity = '0';
        setTimeout(() => {
            mainImg.src = src;
            mainImg.style.opacity = '1';
        }, 200);
    }
</script>

{% endblock %}